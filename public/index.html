<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Digital Nest</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Digital Nest</h1>

<div id="adminPanel" style="display:none; text-align:center; margin-bottom:20px;">
  <input type="file" id="photoInput">
  <input type="text" id="nameInput" placeholder="Item Name">
  <input type="text" id="priceInput" placeholder="Price">
  <input type="number" id="qtyInput" placeholder="Quantity">
  <button onclick="addItem()">Add Item</button>
  <br><br>
  <button onclick="exportJSON()">Export JSON</button>
</div>

<div id="catalog"></div>

<script>
let items = [];

// Fetch latest catalog from server
async function fetchCatalog() {
  const res = await fetch("/api/catalog");
  items = await res.json();
  render();
}

function render() {
  const catalog = document.getElementById("catalog");
  catalog.innerHTML = "";
  items.forEach((item,i)=>{
    const div = document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <img src="${item.photo}">
      <h3>${item.name}</h3>
      <p>Price: ${item.price}</p>
      <p>Qty: ${item.qty}</p>
    `;
    if(item.qty<=0){
      const overlay = document.createElement("div");
      overlay.className="stockOut";
      overlay.textContent="STOCK OUT";
      div.appendChild(overlay);
    }

    if(isAdmin){
      const priceInput = document.createElement("input");
      priceInput.type="text"; priceInput.value=item.price;

      const qtyInput = document.createElement("input");
      qtyInput.type="number"; qtyInput.value=item.qty;

      const saveBtn = document.createElement("button");
      saveBtn.textContent="Save";
      saveBtn.style.background="orange";
      saveBtn.onclick=()=>{
        item.price=priceInput.value;
        item.qty=parseInt(qtyInput.value);
        saveCatalog();
      };

      const delBtn = document.createElement("button");
      delBtn.textContent="Delete";
      delBtn.style.background="crimson";
      delBtn.style.color="white";
      delBtn.onclick=()=>{
        if(confirm("Delete this item?")){
          items.splice(i,1);
          saveCatalog();
        }
      };

      div.append(priceInput, qtyInput, saveBtn, delBtn);
    }

    catalog.appendChild(div);
  });
}

// Admin Mode (password prompt)
let isAdmin=false;
document.addEventListener("keydown", e=>{
  if(e.ctrlKey && e.shiftKey && e.key=="I"){
    isAdmin=true;
    document.getElementById("adminPanel").style.display="block";
    alert("Admin Mode Enabled");
    render();
  }
});

// Upload photo helper
async function uploadPhoto(file){
  const form = new FormData();
  form.append("photo", file);
  const res = await fetch("/api/upload",{method:"POST", body: form});
  const data = await res.json();
  return data.path;
}

// Add Item
async function addItem(){
  const file=document.getElementById("photoInput").files[0];
  const name=document.getElementById("nameInput").value;
  const price=document.getElementById("priceInput").value;
  const qty=parseInt(document.getElementById("qtyInput").value) || 0;

  if(!file || !name || !price) return alert("Fill all fields");

  const photoPath = await uploadPhoto(file);
  items.push({name, price, qty, photo: photoPath});
  saveCatalog();

  document.getElementById("photoInput").value="";
  document.getElementById("nameInput").value="";
  document.getElementById("priceInput").value="";
  document.getElementById("qtyInput").value="";
}

// Save catalog to server
async function saveCatalog(){
  await fetch("/api/catalog", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(items)
  });
  fetchCatalog();
}

// Export JSON
function exportJSON(){
  const blob = new Blob([JSON.stringify(items,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="catalog.json";
  a.click();
}

fetchCatalog();
</script>
</body>
</html>
